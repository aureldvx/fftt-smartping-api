<?php

declare(strict_types=1);

namespace SmartpingApi\Core;

use SmartpingApi\Enum\API;
use SmartpingApi\Exception\HttpException;
use SmartpingApi\Exception\HttpStatusException;

/**
 * Client HTTP pour communiquer avec l'API de la FFTT.
 */
final class HttpClient extends AbstractHttpClient implements HttpClientContract
{
    /**
     * Initialise le client HTTP avec les identifiants fournis par la FFTT.
     *
     * @param string $appId Identifiant unique fourni par la FFTT.
     * @param string $appKey Mot de passe unique fourni par la FFTT.
     * @param string $serial Chaîne de caractères identifiant l'utilisateur de façon permanente, doit respecter le format suivant : [A-Za-z0-9]{15}.
     */
    public function __construct(string $appId, string $appKey, string $serial)
    {
        $this->appId = $appId;
        $this->appKey = $appKey;
        $this->serial = $serial;
        $this->time = date('YmdHis');
        $this->tmc = hash_hmac('sha1', $this->time, hash('md5', $this->appKey));
    }

    /**
     * Appelle un endpoint et le convertit en tableau associatif.
     */
    public function fetch(API $endpoint, array $requestParams): array
    {
        ['response' => $rawResponse, 'contentType' => $contentType] = self::executeCall($endpoint, $requestParams);
        $sanitizedResponse = self::sanitizeResponse($rawResponse, $contentType);

        return self::convertXmlToObject($sanitizedResponse);
    }

    /**
     * Appelle un endpoint de la Fédération.
     *
     *
     * @return array{response: string, contentType: string}
     *
     * @throws HttpException|HttpStatusException
     */
    private function executeCall(API $endpoint, array $requestParams): array
    {
        $ch = curl_init();

        /**
         * Crée les paramètres communs obligatoires.
         */
        $baseParams = [
            'serie' => $this->serial,
            'id' => $this->appId,
            'tm' => $this->time,
            'tmc' => $this->tmc,
        ];

        /**
         * @var array<string, string> $params
         * Merge l'ensemble des paramètres pour la requête.
         */
        $params = array_merge($baseParams, $requestParams);

        /**
         * Transforme les paramètres en paramètres de requête.
         */
        $queryParams = '';
        foreach ($params as $paramKey => $paramValue) {
            $queryParams .= sprintf('&%s=', $paramKey) . urlencode($paramValue);
        }

        /**
         * Supprime le premier `&`.
         */
        $queryParamsEncoded = mb_substr($queryParams, 1);

        /**
         * Exécute la requête.
         */
        curl_setopt_array($ch, [
            CURLOPT_URL => $this->baseUrl . $endpoint->value . '?' . $queryParamsEncoded,
            CURLOPT_HEADER => false,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_SSL_VERIFYPEER => false,
        ]);

        $response = (string) curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        $contentType = curl_getinfo($ch, CURLINFO_CONTENT_TYPE);

        if (curl_error($ch) !== '' && curl_error($ch) !== '0') {
            throw HttpException::make(curl_error($ch));
        }

        curl_close($ch);

        if (200 !== $httpCode) {
            throw HttpStatusException::make($httpCode);
        }

        return [
            'response' => $response,
            'contentType' => $contentType,
        ];
    }
}
